# PromptCraft Backend API

This repository contains the backend API for the PromptCraft application, designed to manage AI prompts, run evaluations, and integrate with various AI models.

## TODO / Future Enhancements

*   **Protect All Endpoints:** Add `Depends(get_current_active_user)` to all relevant prompt, evaluation, and session endpoints to ensure proper authentication and authorization.
*   **Refine Delete Logic:** Determine and implement the desired behavior for deleting prompt versions (e.g., delete all in base, only non-latest, cascade deletes?).
*   **Evaluation Panel Features:** Implement remaining features like Test Set Upload/Standardized Sets, Export, Diff Highlighting, Model Selection.
*   **Prompt Editor Features:** Add Tagging, Share as Example, Branching.
*   **Fix Hydration Error:** Investigate and fix the root cause of the theme-related hydration warning in the frontend.
*   **UI/UX Refinements:** Improve user feedback, add loading states, potentially add debouncing for comment saving.
*   **Unit/Integration Tests:** Add comprehensive tests for backend and potentially frontend.
*   **User Management UI:** Add frontend UI for user profile settings (e.g., changing language, password).
*   **Workspace Context:** Replace simulated language context with a proper user/workspace system.

## Project Structure

```
.
├── app/                  # Main application code
│   ├── core/             # Core functionalities like config, logging
│   │   └── config.py     # Pydantic settings management
│   ├── db/               # Database interaction layer
│   │   └── client.py     # MongoDB client setup (async with motor)
│   ├── models/           # Pydantic data models (for API request/response and DB)
│   ├── routes/           # API endpoint definitions (FastAPI routers)
│   └── services/         # Business logic (e.g., AI model interaction)
├── .env.example        # Example environment variables file
├── main.py             # FastAPI application entry point
├── README.md           # This file
└── requirements.txt    # Python dependencies
```

## Setup

1.  **Clone the repository:**
    ```bash
    git clone <repository-url>
    cd <repository-directory>
    ```

2.  **Create a virtual environment:** (Recommended)
    ```bash
    python -m venv venv
    source venv/bin/activate  # On Windows use `venv\Scripts\activate`
    ```

3.  **Install dependencies:**
    ```bash
    pip install -r requirements.txt
    ```

4.  **Configure environment variables:**
    *   Copy the example environment file:
        ```bash
        cp .env.example .env
        ```
    *   Edit the `.env` file and provide your actual MongoDB connection string (`MONGO_URL`) and your Anthropic API key (`ANTHROPIC_API_KEY`).

## Running the Application (Development)

Use Uvicorn to run the FastAPI application:

```bash
uvicorn main:app --reload --host 127.0.0.1 --port 8000
```

*   `--reload`: Enables auto-reloading when code changes (useful for development).
*   `--host`: The interface to bind to (127.0.0.1 for local access only).
*   `--port`: The port to listen on.

You can access the API documentation (Swagger UI) automatically generated by FastAPI at `http://127.0.0.1:8000/docs`.

## Running with Docker Compose (Recommended)

This method runs both the backend API and the MongoDB database in containers.

1.  **Ensure Docker and Docker Compose are installed.**

2.  **Configure Environment Variables:**
    *   Make sure you have a `.env` file (copy `.env.example` if needed).
    *   **Important:** When running with Docker Compose, the backend container needs to connect to the database container using its service name. Update the `MONGO_URL` in your `.env` file:
        ```env
        # Use the service name 'database' as the host
        MONGO_URL=mongodb://database:27017/promptcraft_db
        
        # Other variables (like ANTHROPIC_API_KEY) remain the same
        ANTHROPIC_API_KEY=your_anthropic_api_key_here
        LOG_LEVEL=INFO
        ```

3.  **Build and Run:**
    Open your terminal in the project root directory and run:
    ```bash
    docker-compose up --build
    ```
    *   `--build`: Forces Docker Compose to rebuild the backend image if the `Dockerfile` or application code has changed.
    *   The first time you run this, it will download the `python` and `mongo` images and build your backend image, which might take a few minutes.
    *   Subsequent runs will be much faster.

4.  **Accessing the Application:**
    *   The API will be available at `http://localhost:8000`.
    *   The API docs (Swagger UI) will be at `http://localhost:8000/docs`.
    *   The MongoDB database is accessible from your host machine at `mongodb://localhost:27017` if you need to connect directly using a tool like MongoDB Compass (useful for debugging).

5.  **Stopping the Application:**
    Press `Ctrl+C` in the terminal where `docker-compose up` is running. To remove the containers (but keep the `mongo_data` volume), you can run:
    ```bash
    docker-compose down
    ```

## Next Steps

This initial setup includes:
*   FastAPI application instance.
*   MongoDB connection management during application lifespan.
*   Configuration loading from `.env` file.
*   Basic logging setup.

Next, we will implement:
1.  Pydantic models for Prompts and Evaluations.
2.  API routes for Prompt CRUD operations.
3.  API routes and services for running Evaluations using the Claude API.